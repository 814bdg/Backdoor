# BDG file for building iOS dylib and XCFramework

# Variables
SDK = $(shell xcrun --sdk iphoneos --show-sdk-path)
TARGET = arm64-apple-ios14.0
LIB_NAME = cpux_lib
FRAMEWORK_NAME = $(LIB_NAME).framework
XCFRAMEWORK_NAME = $(LIB_NAME).xcframework
HEADERS_DIR = $(FRAMEWORK_NAME)/Headers
MODULES_DIR = $(FRAMEWORK_NAME)/Modules

# Build rules
all: $(XCFRAMEWORK_NAME)

$(XCFRAMEWORK_NAME): $(FRAMEWORK_NAME)
	xcodebuild -create-xcframework -framework $(FRAMEWORK_NAME) -output $(XCFRAMEWORK_NAME)

$(FRAMEWORK_NAME): $(FRAMEWORK_NAME)/$(LIB_NAME)
	mkdir -p $(HEADERS_DIR)
	cp $(LIB_NAME).h $(HEADERS_DIR)
	mkdir -p $(MODULES_DIR)
	echo 'framework module $(LIB_NAME) { header "$(LIB_NAME).h" export * }' > $(MODULES_DIR)/module.modulemap

$(FRAMEWORK_NAME)/$(LIB_NAME): $(LIB_NAME).o
	mkdir -p $(FRAMEWORK_NAME)
	libtool -static $< -o $@

$(LIB_NAME).o: $(LIB_NAME).c $(LIB_NAME).h
	clang -target $(TARGET) -isysroot $(SDK) -fPIC -c $< -o $@

clean:
	rm -rf $(LIB_NAME).o $(FRAMEWORK_NAME) $(XCFRAMEWORK_NAME)

.PHONY: all clean